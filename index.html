<!DOCTYPE html>
<htmml lang= "en">
    <head>
        <title>
        Here Maps : BITSians
        </title>
        <meta name="viewport" charset="utf-8" content="initial-scale=1.0, width=sevice-width" />
        <script src="creds.js"></script>
        <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript"></script>
        <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript"></script>
        <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript"></script>
        <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js" type="text/javascript"></script>
        <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    </head>
    <body>
        <div id="mapContainer" style="width: 100vw; height: 80vh; align-self: center; background-color: aqua;"></div>
    </body>
    <script>
        var platform = new H.service.Platform({
        'apikey': window.hereCreds.JSKEY
        });
        var myPos = {lat:18.52571, lng:74.09815};
        
        // Obtain the default map types from the platform object:
        var defaultLayers = platform.createDefaultLayers();

        // Instantiate (and display) a map object:
        var map = new H.Map(
            document.getElementById('mapContainer'),
            defaultLayers.vector.normal.map,
        {
            zoom: 10,
            center: { lat: 18.52571, lng: 74.09815 }
        });

        // Create the default UI:
        var ui = H.ui.UI.createDefault(map, defaultLayers,'en-US');
        ui.getControl('mapsettings').setDisabled(false)
        ui.getControl('zoom').setDisabled(false)
        ui.getControl('scalebar').setDisabled(false)

        // Positions of the UI components:
        var mapSettings = ui.getControl('mapsettings');
        var scalebar = ui.getControl('scalebar');
        mapSettings.setAlignment('top-left');
        scalebar.setAlignment('bottom-right');

        // Create an info bubble object at a specific geographic location:
        var bubble = new H.ui.InfoBubble({ lng: 18.52571, lat: 74.09815 }, {
                content: '<b>Pune</b>'
        });

        // Add info bubble to the UI:
        ui.addBubble(bubble);

        // Enable the event system on the map instance:
        var mapEvents = new H.mapevents.MapEvents(map);
        var behavior = new H.mapevents.Behavior(mapEvents);

        map.getViewModel().setLookAtData({
           tilt: 45
        });

        // Define a variable holding SVG mark-up that defines an icon image:
        /* var svgMarkup = '<svg width="24" height="24" ' +
            'xmlns="http://www.w3.org/2000/svg">' +
            '<rect stroke="white" fill="#228B22" x="1" y="1" width="22" ' +
            'height="22" /><text x="12" y="18" font-size="12pt" ' +
            'font-family="Arial" font-weight="bold" text-anchor="middle" ' +
            'fill="white">.</text></svg>'; */
        
        let imgIcon = new H.map.Icon('robot.png');

        function getBrowserPosition(){
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    console.log(position.coords);
                    let browserPosition = {lat: position.coords.latitude , lng: position.coords.longitude };
                    // Create a marker:
                    var icon = new H.map.Icon('gps.png');
                    let marker = new H.map.Marker(browserPosition, {icon: icon});
                    // Instantiate a circle object (using the default style):
                    var circle = new H.map.Circle({lat: position.coords.latitude + 0.015, lng: position.coords.longitude }, 7500, {style: circleStyle});
                    marker.setData("You're here!");
                    // Add the circle to the map:
                    map.addObject(circle);

                    map.addObject(marker);

                });
            } else {
                alert("Geolocation is not supported by this browser!");
            }
        }

        // Create a style object:
        var circleStyle = {
        
            strokeColor: 'green',
            fillColor: 'rgba(66, 245, 126, 0.25)',
            opacity: 0.5
  
        };
        

        function clickToMark(){
            // Add event listener:
            map.addEventListener('tap', function(evt) {
                if(evt.target instanceof H.map.Marker){
                    //bubble
                    // Create an info bubble object at a specific geographic location:
                    var bubble = new H.ui.InfoBubble(evt.target.getGeometry(), {
                    content: evt.target.getData()
             });

                    // Add info bubble to the UI:
                    ui.addBubble(bubble);

                }
                else{
                    // Log 'tap' and 'mouse' events:
                    console.log(evt); // too much data here (try to minify)
                    let pointer = evt.currentPointer;
                    let pointerPoistion = map.screenToGeo(pointer.viewportX, pointer.viewportY);
                    let pointerMarker = new H.map.Marker(pointerPoistion,{icon: imgIcon, volatility: true});
                    pointerMarker.draggable = true;
                    pointerMarker.setData("Data goes here!");   
                    map.addObject(pointerMarker);
                }
            });
        }

        function clickDragMarkers(){
                // disable the default draggability of the underlying map
                // and calculate the offset between mouse and target's position
                // when starting to drag a marker object:
                map.addEventListener('dragstart', function(ev) {
                    var target = ev.target,
                        pointer = ev.currentPointer;
                    if (target instanceof H.map.Marker) {
                    var targetPosition = map.geoToScreen(target.getGeometry());
                    target['offset'] = new H.math.Point(pointer.viewportX - targetPosition.x, pointer.viewportY - targetPosition.y);
                    behavior.disable();
                    }
                }, false);


                // re-enable the default draggability of the underlying map
                // when dragging has completed
                map.addEventListener('dragend', function(ev) {
                    var target = ev.target;
                    if (target instanceof H.map.Marker) {
                      
                        
                    behavior.enable();
                    }
                }, false);

                // Listen to the drag event and move the position of the marker
                // as necessary
                map.addEventListener('drag', function(ev) {
                    var target = ev.target,
                        pointer = ev.currentPointer;
                    if (target instanceof H.map.Marker) {
                    target.setGeometry(map.screenToGeo(pointer.viewportX - target['offset'].x, pointer.viewportY - target['offset'].y));
                    }
                }, false);
        }



        getBrowserPosition();

        clickToMark();

        clickDragMarkers();

    </script>
</htmml>
